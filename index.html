<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Timbre del Edificio</title>
  <link href="https://fonts.googleapis.com/css2?family=Lato&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="canvas">
    <div class="header">
      <div class="header-label">Clickeá el depto<br>a comunicarte</div>
      <div class="header-address">Av. Córdoba 5323</div>
    </div>

    <div class="grid-header">
      <div class="grid-title">piso</div>
      <div class="grid-divider"></div>
      <div class="grid-title">depto</div>
    </div>

    <div class="grid-container" id="timbre">
      <p class="loading">Cargando datos...</p>
    </div>
  </div>

  <script>
    const sheetID = "1Nv2h4cniDmn7LRcovyyVNKSfjiEr9lX5OaqqHFq5za0"; // ID de tu Sheet
    const sheetURL = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json`;

    async function cargarDatos() {
      try {
        const response = await fetch(sheetURL);
        const text = await response.text();
        const json = JSON.parse(text.substring(47).slice(0, -2));
        const rows = json.table.rows;

        const pisos = {};

        rows.forEach(row => {
          const piso = row.c[0]?.v || '';
          const depto = row.c[1]?.v || '';
          const celular = row.c[2]?.v || '';

          if (piso && depto && celular) {
            if (!pisos[piso]) pisos[piso] = [];
            pisos[piso].push({ depto, celular });
          }
        });

        const contenedor = document.getElementById('timbre');
        contenedor.innerHTML = '';

        for (const [piso, deptos] of Object.entries(pisos)) {
          const pisoDiv = document.createElement('div');
          pisoDiv.className = 'floor';
          pisoDiv.textContent = piso;

          const deptoContainer = document.createElement('div');
          deptoContainer.className = 'depto-container';

          deptos.forEach(({ depto, celular }) => {
            const mensaje = "*TIMBRE* 👋🏻🛎️\nHola, estoy abajo soy __";
            const encodedMensaje = encodeURIComponent(mensaje);
            const link = document.createElement('a');
            link.className = 'depto-btn';
            link.href = `https://wa.me/${celular}?text=${encodedMensaje}`;
            link.target = '_blank';
            link.textContent = depto;
            deptoContainer.appendChild(link);
          });

          contenedor.appendChild(pisoDiv);
          contenedor.appendChild(deptoContainer);
        }
      } catch (err) {
        console.error('Error cargando datos', err);
        document.getElementById('timbre').innerHTML = '<p class="error">Error al cargar datos.</p>';
      }
    }

    cargarDatos();
  </script>
</body>
</html>
